コマンドライン・インタフェース
==============================

ここでは Jageocoder をコマンドラインから呼びだして
利用する方法を説明します。
同じ内容はオンラインヘルプでも確認できます。

.. code-block:: console

   $ jageocoder -h

.. _commandline-geocoding:

ジオコーディング
----------------

住所文字列をキーとして住所辞書データベースを検索し、
先頭から最長一致するレコードを取得し、そのレコードの情報を返します。

最長一致する候補が複数存在する場合、全ての候補を返します。

コマンド
   ``search``

パラメータ
   住所文字列

オプション
   ``-d`` デバッグ情報を表示します。

   ``--area=<area>`` 検索する都道府県や市区町村を指定します。
   省略した場合は全国を対象とします。複数の都道府県・市区町村を
   指定する場合は ``,`` で区切ります。

   ``--db-dir=<dir>`` 住所辞書データベースを配置したディレクトリを
   指定します。

   ``-url=<url>`` Jageocoder サーバのエンドポイント URL を指定します。

**実行例**

.. code-block:: console

   # 「落合１－１５－２」を検索します。
   # 「栃木県下都賀郡壬生町落合一丁目15番2号」
   # 「広島県広島市安佐北区落合一丁目15番2号」
   # 「東京都多摩市落合一丁目15番地2」
   # 「広島県広島市安佐北区落合一丁目15番地2」が返ります。
    $ jageocoder search '落合１－１５－２'
   {"matched": "落合１－１５－２", "candidates": [{"id": 38651481, "name": "2号", "x": 139.82020568847656, "y": 36.450565338134766, "level": 8, "priority": 4, "note": "", "fullname": ["栃木県", "下都賀郡", "壬生町", "落合", "一丁目", "15番", "2号"]}, {"id": 106341148, "name": "2号", "x": 132.51043701171875, "y": 34.47321319580078, "level": 8, "priority": 4, "note": "", "fullname": ["広島県", "広島市", "安佐北区", "落合", "一丁目", "15番", "2号"]}, {"id": 50058048, "name": "2", "x": 139.4287567138672, "y": 35.62576675415039, "level": 8, "priority": 7, "note": "", "fullname": ["東京都", "多摩市", "落合", "一丁目", "15番地", "2"]}, {"id": 106341162, "name": "2", "x": 132.5104217529297, "y": 34.47317123413086, "level": 8, "priority": 7, "note": "", "fullname": ["広島県", "広島市", "安佐北区", "落合", "一丁目", "15番地", "2"]}]}

   # ``--area`` オプションで検索対象を東京都に限定し、
   # 「落合１－１５－２」を検索します。
   # 「東京都多摩市落合一丁目15番地」だけが返ります。
    $ jageocoder search --area=東京都 '落合１－１５－２'
   {"matched": "落合１－１５－２", "candidates": [{"id": 50058048, "name": "2", "x": 139.4287567138672, "y": 35.62576675415039, "level": 8, "priority": 7, "note": "", "fullname": ["東京都", "多摩市", "落合", "一丁目", "15番地", "2"]}]}


.. _commandline-reverse-geocoding:

リバースジオコーディング
------------------------

経度・緯度を指定し、その地点を囲む3点のレコードを検索し、
そのレコードリストの情報と地点からの距離を指定地点に近い順に返します。

岬の突端や離島など、指定地点を囲む3点のレコードが存在しない場合は
リストに含まれるレコード数が3より小さい場合もあります。

住所データベースには「住所に対応する代表点」の座標しか含まれておらず、
その住所が表す範囲（形状）の情報は利用していないため、
「指定した地点に近い代表点」を検索していることに注意してください。

コマンド
   ``reverse``

パラメータ
   経度 緯度 （WGS1984 の十進度表記）

オプション
   ``-d`` デバッグ情報を表示します。

   ``--level=<level>`` 指定した住所レベルまで検索します。
   デフォルトは 6 (字レベル) です。

   ``--db-dir=<dir>`` 住所データベースを配置したディレクトリを指定します。

**実行例**

.. code-block:: console

   # 経度 139.6917, 緯度 35.6896 の地点付近の住所を検索します。
   # 「東京都新宿区西新宿二丁目」、「東京都新宿区西新宿六丁目」、
   # 「東京都新宿区西新宿四丁目」が返ります。
    $ jageocoder reverse 139.6917 35.6896
   [{"candidate": {"id": 50372222, "name": "二丁目", "x": 139.6917724609375, "y": 35.689449310302734, "level": 6, "priority": 2, "note": "aza_id:0023002/postcode:1600023", "fullname": ["東京都", "新宿区", "西新宿", "二丁目"]}, "dist": 17.959975373852735}, {"candidate": {"id": 50373915, "name": "六丁目", "x": 139.6909637451172, "y": 35.693424224853516, "level": 6, "priority": 2, "note": "aza_id:0023006/postcode:1600023", "fullname": ["東京都", "新宿区", "西新宿", "六丁目"]}, "dist": 429.5116877067265}, {"candidate": {"id": 50372614, "name": "四丁目", "x": 139.6876220703125, "y": 35.687538146972656, "level": 6, "priority": 2, "note": "aza_id:0023004/postcode:1600023", "fullname": ["東京都", "新宿区", "西新宿", "四丁目"]}, "dist": 434.2648526035473}]

   # 経度 139.6917, 緯度 35.6896 の地点付近の住所を
   # 街区（○番）レベルで検索します。
   # 「東京都新宿区西新宿二丁目8番」、「東京都新宿区西新宿二丁目10番」、
   # 「東京都新宿区西新宿四丁目15番」が返ります。
    $ jageocoder reverse 139.6917 35.6896 --level=7
   [{"candidate": {"id": 50372232, "name": "8番", "x": 139.6917724609375, "y": 35.68962860107422, "level": 7, "priority": 3, "note": "", "fullname": ["東京都", "新宿区", "西新宿", "二丁目", "8番"]}, "dist": 7.286211365075872}, {"candidate": {"id": 50372224, "name": "10番", "x": 139.689697265625, "y": 35.687679290771484, "level": 7, "priority": 3, "note": "", "fullname": ["東京都", "新宿区", "西新宿", "二丁目", "10番"]}, "dist": 279.78246727626146}, {"candidate": {"id": 50372715, "name": "15番", "x": 139.68817138671875, "y": 35.68926239013672, "level": 7, "priority": 3, "note": "", "fullname": ["東京都", "新宿区", "西新宿", "四丁目", "15番"]}, "dist": 321.58463778054926}]

.. note::

   リバースジオコーディング用のインデックスは、初めてリバース
   ジオコーディングを実行した時に自動的に作成されます。
   この処理には辞書データーベースのサイズやマシン性能によって
   非常に長い時間がかかる (数十分) ので、辞書データベースのインストール後に
   ``jageocoder reverse 135 34`` のように実行して
   インデックスを構築しておくことをお勧めします。

   インデックスを削除したい場合は、辞書データベースのディレクトリにある
   ``rtree.dat`` ``rtree.idx`` という 2 つのファイルを削除してください。


.. _commandline-get-db-dir:

住所辞書ディレクトリの取得
--------------------------

実行中の Python 環境で、住所辞書データベースがインストールされている
ディレクトリを取得します。

辞書データベースは ``{sys.prefix}/jageocoder/db2/`` の下に
作成されますが、ユーザが書き込み権限を持っていない場合には
``{site.USER_DATA}/jageocoder/db2/`` に作成されます。

上記以外の任意の場所を指定したい場合、環境変数 ``JAGEOCODER_DB2_DIR``
でディレクトリを指定することができます。

コマンド
   ``get-db-dir``

パラメータ
   （なし）

オプション
   ``-d`` デバッグ情報を表示します。

**実行例**

.. code-block:: console

   $ jageocoder get-db-dir
   /home/sagara/.local/share/virtualenvs/jageocoder-kWBL7Ve6/jageocoder/db2/


.. _commandline-download-dictionary:

住所辞書ファイルのダウンロード
------------------------------

住所データベースファイルをウェブからダウンロードします。

`住所データベースファイル <https://www.info-proto.com/static/jageocoder/latest/v2/>`_
のリストからダウンロードするファイルを選択し、その URL を指定してください。

このコマンドは ``curl`` や ``wget`` コマンドなどが利用できない場合を
想定して用意しているものなので、これらのコマンドやブラウザで
ダウンロードしても問題ありません。

コマンド
   ``download-dictionary``

パラメータ
   ``<url>`` ダウンロードする URL を指定します（省略不可）。

オプション
   ``-d`` デバッグ情報を表示します。

**実行例**

.. code-block:: console

   # 街区レベルまでの全国住所辞書ファイルをダウンロードします
   $ jageocoder download-dictionary https://www.info-proto.com/static/jageocoder/latest/v2/gaiku_all_v21.zip


.. _commandline-install-dictionary:

住所辞書ファイルのインストール
------------------------------

住所データベースファイルを展開し、住所データベースを作ります。

コマンド
   ``install-dictionary``

パラメータ
   ``<path>`` インストールする住所データベースファイルのパスを指定します（省略不可）。

オプション
   ``-d`` デバッグ情報を表示します。

   ``--db-dir`` 住所データベースを作るディレクトリを指定します。

**実行例**

.. code-block:: console

   # ダウンロード済みの住所データベースファイルをインストールします
    $ jageocoder install-dictionary gaiku_all_v21.zip


.. _commandline-uninstall-dictionary:

住所データベースのアンインストール
----------------------------------

住所データベースをアンインストール（削除）します。

コマンド
   ``uninstall-dictionary``

パラメータ
   （なし）

オプション
   ``-d`` デバッグ情報を表示します。

   ``--db-dir=<dir>`` 住所データベースのディレクトリを指定します。

**実行例**

.. code-block:: console

   # 住所データベースをアンインストールします
    $ jageocoder uninstall-dictionary
   INFO:jageocoder.module:248:Removing directory ...
   INFO:jageocoder.module:251:Dictionary has been uninstalled.


.. _commandline-migrate-dictionary:

住所辞書ファイルのマイグレーション
----------------------------------

この機能は v2.0 で廃止になりました。